[
    {
        "title": "fix: SSRF proxy file descriptor leak in concurrent requests"
    },
    {
        "author": {
            "login": "PR Description"
        },
        "body": "# Summary\r\n\r\nThis PR addresses the `[Errno 9] File descriptor was closed in another greenlet` error that occurs when using the SSRF proxy in concurrent workflows (e.g., greenlets, threads).\r\n\r\n**Changes**:  \r\n1. **Dynamic Transport Initialization**  \r\n   - Fresh `httpx.HTTPTransport` instances are now created for each request when `SSRF_PROXY_HTTP_URL` and `SSRF_PROXY_HTTPS_URL` are configured.  \r\n   - Removes the global `proxy_mounts` variable to prevent shared transports across requests.  \r\n\r\n2. **Concurrency Safety**  \r\n   - Fixes race conditions caused by reusing the same transports in asynchronous/greenlet contexts.  \r\n\r\nClose https://github.com/langgenius/dify/issues/10572\r\n# Checklist\r\n\r\n> [!IMPORTANT]  \r\n> Please review the checklist below before submitting your pull request.\r\n\r\n- [ ] This change requires a documentation update, included: [Dify Document](https://github.com/langgenius/dify-docs)\r\n- [x] I understand that this PR may be closed in case there was no previous discussion or issues. (This doesn't apply to typos!)\r\n- [x] I've added a test for each change that was introduced, and I tried as much as possible to make a single atomic change.\r\n- [x] I've updated the documentation accordingly.\r\n- [x] I ran `dev/reformat`(backend) and `cd web && npx lint-staged`(frontend) to appease the lint gods\r\n\r\n"
    },
    {
        "author": {
            "login": "Yeuoly"
        },
        "body": "LGTM"
    },
    {
        "author": {
            "login": "matt08"
        },
        "body": "It seems that this might solve a significant problem with running multiple workflows simultaneously, which at the same time perform an HTTP Request:\r\n![CleanShot 2025-02-02 at 19 06 17@2x](https://github.com/user-attachments/assets/46e1e873-1fd9-4c56-bd88-2ee519945097)\r\n\r\nThis is a serious problem that currently significantly hinders the use of multiple workflow calls simultaneously using HTTP requests. Reported, for example, in #10572 "
    },
    {
        "author": {
            "login": "laipz8200"
        },
        "body": "That's a beautiful fix, thank you so much!"
    },
    {
        "data": {
            "repository": {
                "issue": {
                    "title": "parallel iteration bug report",
                    "body": "### Self Checks\r\n\r\n- [X] This is only for bug report, if you would like to ask a question, please head to [Discussions](https://github.com/langgenius/dify/discussions/categories/general).\r\n- [X] I have searched for existing issues [search for existing issues](https://github.com/langgenius/dify/issues), including closed ones.\r\n- [X] I confirm that I am using English to submit this report (\u6211\u5df2\u9605\u8bfb\u5e76\u540c\u610f [Language Policy](https://github.com/langgenius/dify/issues/1542)).\r\n- [X] [FOR CHINESE USERS] \u8bf7\u52a1\u5fc5\u4f7f\u7528\u82f1\u6587\u63d0\u4ea4 Issue\uff0c\u5426\u5219\u4f1a\u88ab\u5173\u95ed\u3002\u8c22\u8c22\uff01:\uff09\r\n- [X] Please do not modify this template :) and fill in all the required fields.\r\n\r\n### Dify version\r\n\r\n0.11.0\r\n\r\n### Cloud or Self Hosted\r\n\r\nSelf Hosted (Docker)\r\n\r\n### Steps to reproduce\r\n\r\nwhen running http request in a iteration parallel, it got error:Reached maximum retries (3) for URL https://www.runoob.com/test/demo_form.php\r\n\r\n\r\nthis is the log:\r\n2024-11-12 03:39:27,387.387 WARNING [ThreadPoolExecutor-101_1] [ssrf_proxy.py:54] - Request to URL https://www.runoob.com/test/demo_form.php failed on attempt 2: [Errno 9] File descriptor was closed in another greenlet\r\n\r\nthis is the yaml config:\r\n\r\n```\r\napp:\r\n  description: \u6d4b\u8bd5\u66ff\u6362\u6839\u636e\u4e3b\u9898\u68c0\u7d22\u5173\u8054\u8d44\u8baf\r\n  icon: \ud83e\udd16\r\n  icon_background: '#FFEAD5'\r\n  mode: workflow\r\n  name: \u62a5\u544a\u751f\u6210\u5de5\u4f5c\u6d41_20241112_cuixuan\r\n  use_icon_as_answer_icon: false\r\nkind: app\r\nversion: 0.1.3\r\nworkflow:\r\n  conversation_variables: []\r\n  environment_variables: []\r\n  features:\r\n    file_upload:\r\n      allowed_file_extensions:\r\n      - .JPG\r\n      - .JPEG\r\n      - .PNG\r\n      - .GIF\r\n      - .WEBP\r\n      - .SVG\r\n      allowed_file_types:\r\n      - image\r\n      allowed_file_upload_methods:\r\n      - local_file\r\n      - remote_url\r\n      enabled: false\r\n      fileUploadConfig:\r\n        audio_file_size_limit: 50\r\n        batch_count_limit: 5\r\n        file_size_limit: 15\r\n        image_file_size_limit: 10\r\n        video_file_size_limit: 100\r\n        workflow_file_upload_limit: 10\r\n      image:\r\n        enabled: false\r\n        number_limits: 3\r\n        transfer_methods:\r\n        - local_file\r\n        - remote_url\r\n      number_limits: 3\r\n    opening_statement: ''\r\n    retriever_resource:\r\n      enabled: false\r\n    sensitive_word_avoidance:\r\n      enabled: false\r\n    speech_to_text:\r\n      enabled: false\r\n    suggested_questions: []\r\n    suggested_questions_after_answer:\r\n      enabled: false\r\n    text_to_speech:\r\n      enabled: false\r\n      language: ''\r\n      voice: ''\r\n  graph:\r\n    edges:\r\n    - data:\r\n        isInIteration: false\r\n        sourceType: code\r\n        targetType: iteration\r\n      id: 1730346539705-source-1731381770656-target\r\n      selected: false\r\n      source: '1730346539705'\r\n      sourceHandle: source\r\n      target: '1731381770656'\r\n      targetHandle: target\r\n      type: custom\r\n      zIndex: 0\r\n    - data:\r\n        isInIteration: false\r\n        sourceType: iteration\r\n        targetType: end\r\n      id: 1731381770656-source-1731381793827-target\r\n      selected: false\r\n      source: '1731381770656'\r\n      sourceHandle: source\r\n      target: '1731381793827'\r\n      targetHandle: target\r\n      type: custom\r\n      zIndex: 0\r\n    - data:\r\n        isInIteration: false\r\n        sourceType: start\r\n        targetType: code\r\n      id: 1730169413286-source-1731381870748-target\r\n      selected: false\r\n      source: '1730169413286'\r\n      sourceHandle: source\r\n      target: '1731381870748'\r\n      targetHandle: target\r\n      type: custom\r\n      zIndex: 0\r\n    - data:\r\n        isInIteration: false\r\n        sourceType: code\r\n        targetType: code\r\n      id: 1731381870748-source-1730346539705-target\r\n      selected: false\r\n      source: '1731381870748'\r\n      sourceHandle: source\r\n      target: '1730346539705'\r\n      targetHandle: target\r\n      type: custom\r\n      zIndex: 0\r\n    - data:\r\n        isInIteration: true\r\n        iteration_id: '1731381770656'\r\n        sourceType: iteration-start\r\n        targetType: http-request\r\n      id: 1731381770656start-source-1731382677649-target\r\n      source: 1731381770656start\r\n      sourceHandle: source\r\n      target: '1731382677649'\r\n      targetHandle: target\r\n      type: custom\r\n      zIndex: 1002\r\n    nodes:\r\n    - data:\r\n        desc: \u8f93\u5165\u4e3b\u9898\u548c\u5927\u7eb2(\u53ef\u9009)\r\n        selected: false\r\n        title: \u5f00\u59cb\r\n        type: start\r\n        variables:\r\n        - label: \u662f\u5426\u9884\u5b9a\u4e49\u5927\u7eb2\r\n          max_length: 48\r\n          options:\r\n          - \u9884\u5b9a\u4e49(\u4eba\u5de5\u8f93\u5165\u5927\u7eb2)\r\n          - \u81ea\u5b9a\u4e49(\u7cfb\u7edf\u751f\u6210\u5927\u7eb2)\r\n          required: true\r\n          type: select\r\n          variable: has_outline\r\n        - label: \u4e3b\u9898\u62a5\u544a\u5927\u7eb2\r\n          max_length: null\r\n          options: []\r\n          required: false\r\n          type: paragraph\r\n          variable: outline\r\n        - label: \u662f\u5426\u8fdb\u884c\u5143\u641c\u7d22\r\n          max_length: 48\r\n          options:\r\n          - \u662f\r\n          - \u5426\r\n          required: true\r\n          type: select\r\n          variable: is_meta_search\r\n        - label: \u521d\u59cb\u4e3b\u9898\r\n          max_length: null\r\n          options: []\r\n          required: true\r\n          type: text-input\r\n          variable: initial_topic\r\n      height: 196\r\n      id: '1730169413286'\r\n      position:\r\n        x: 30\r\n        y: 297.5\r\n      positionAbsolute:\r\n        x: 30\r\n        y: 297.5\r\n      selected: false\r\n      sourcePosition: right\r\n      targetPosition: left\r\n      type: custom\r\n      width: 244\r\n    - data:\r\n        author: admin\r\n        desc: ''\r\n        height: 88\r\n        selected: false\r\n        showAuthor: false\r\n        text: '{\"root\":{\"children\":[{\"children\":[{\"detail\":0,\"format\":0,\"mode\":\"normal\",\"style\":\"\",\"text\":\"\u8f6c\u6362\u683c\u5f0f\uff0c\u5e76\u4e0e\u539f\u5173\u952e\u8bcd\u68c0\u7d22\u76f8\u5173\u5185\u5bb9\u5408\u5e76\",\"type\":\"text\",\"version\":1}],\"direction\":\"ltr\",\"format\":\"\",\"indent\":0,\"type\":\"paragraph\",\"version\":1,\"textFormat\":0}],\"direction\":\"ltr\",\"format\":\"\",\"indent\":0,\"type\":\"root\",\"version\":1}}'\r\n        theme: blue\r\n        title: ''\r\n        type: ''\r\n        width: 240\r\n      height: 88\r\n      id: '1730271773207'\r\n      position:\r\n        x: 9025.60295847669\r\n        y: 370.18897048412254\r\n      positionAbsolute:\r\n        x: 9025.60295847669\r\n        y: 370.18897048412254\r\n      selected: false\r\n      sourcePosition: right\r\n      targetPosition: left\r\n      type: custom-note\r\n      width: 240\r\n    - data:\r\n        author: admin\r\n        desc: ''\r\n        height: 88\r\n        selected: false\r\n        showAuthor: false\r\n        text: '{\"root\":{\"children\":[{\"children\":[{\"detail\":0,\"format\":0,\"mode\":\"normal\",\"style\":\"\",\"text\":\"\u8f6c\u6362\u683c\u5f0f\uff0c\u5e76\u4e0e\u539f\u5173\u952e\u8bcd\u641c\u7d22\u7684\u76f8\u5173\u5185\u5bb9\u5408\u5e76\",\"type\":\"text\",\"version\":1}],\"direction\":\"ltr\",\"format\":\"\",\"indent\":0,\"type\":\"paragraph\",\"version\":1,\"textFormat\":0}],\"direction\":\"ltr\",\"format\":\"\",\"indent\":0,\"type\":\"root\",\"version\":1}}'\r\n        theme: blue\r\n        title: ' (1)'\r\n        type: ''\r\n        width: 240\r\n      height: 88\r\n      id: '17302727232850'\r\n      position:\r\n        x: 9017.592958164108\r\n        y: 775.395527452795\r\n      positionAbsolute:\r\n        x: 9017.592958164108\r\n        y: 775.395527452795\r\n      selected: false\r\n      sourcePosition: right\r\n      targetPosition: left\r\n      type: custom-note\r\n      width: 240\r\n    - data:\r\n        code: \"def main(trans_topic_str: str, initial_topic: str) -> dict:\\n    trans_topic_str\\\r\n          \\ = trans_topic_str.strip()\\n    trans_topics = trans_topic_str.split(\\\"\\\r\n          \\\\n\\\")\\n    # \u4f7f\u7528 lambda \u8868\u8fbe\u5f0f\u7b5b\u9009\u975e\u7a7a\u884c\\n    trans_topics = list(filter(lambda\\\r\n          \\ topic: topic.strip()!= \\\"\\\", trans_topics))\\n    # \u5bf9\u7b5b\u9009\u540e\u7684\u5217\u8868\u4e2d\u7684\u6bcf\u4e2a\u5143\u7d20\u8fdb\u884c\u53bb\u9664\u7a7a\u683c\u64cd\u4f5c\\n\\\r\n          \\    return {\\n        \\\"topics\\\": list(map(lambda topic: topic.strip(),\\\r\n          \\ trans_topics))[:9] + [initial_topic]\\n    }\"\r\n        code_language: python3\r\n        desc: \u63d0\u53d6\u6269\u5199\u7684\u4e3b\u9898\u5217\u8868\uff0c\u4e0e\u539f\u59cb\u4e3b\u9898\u5408\u5e76\u5904\u7406\r\n        outputs:\r\n          topics:\r\n            children: null\r\n            type: array[string]\r\n        selected: false\r\n        title: \u63d0\u53d6\u5e76\u5408\u5e76\u4e3b\u9898\u5217\u8868\r\n        type: code\r\n        variables:\r\n        - value_selector:\r\n          - '1730169413286'\r\n          - initial_topic\r\n          variable: initial_topic\r\n        - value_selector:\r\n          - '1731381870748'\r\n          - trans_topic_str\r\n          variable: trans_topic_str\r\n      height: 98\r\n      id: '1730346539705'\r\n      position:\r\n        x: 619.3051178149508\r\n        y: 297.5\r\n      positionAbsolute:\r\n        x: 619.3051178149508\r\n        y: 297.5\r\n      selected: false\r\n      sourcePosition: right\r\n      targetPosition: left\r\n      type: custom\r\n      width: 244\r\n    - data:\r\n        desc: ''\r\n        error_handle_mode: terminated\r\n        height: 198\r\n        is_parallel: true\r\n        iterator_selector:\r\n        - '1730346539705'\r\n        - topics\r\n        output_selector:\r\n        - '1731382677649'\r\n        - body\r\n        output_type: array[string]\r\n        parallel_nums: 9\r\n        selected: false\r\n        start_node_id: 1731381770656start\r\n        title: \u8fed\u4ee3\r\n        type: iteration\r\n        width: 388\r\n      height: 198\r\n      id: '1731381770656'\r\n      position:\r\n        x: 922.4922968503834\r\n        y: 297.5\r\n      positionAbsolute:\r\n        x: 922.4922968503834\r\n        y: 297.5\r\n      selected: true\r\n      sourcePosition: right\r\n      targetPosition: left\r\n      type: custom\r\n      width: 388\r\n      zIndex: 1\r\n    - data:\r\n        desc: ''\r\n        isInIteration: true\r\n        selected: false\r\n        title: ''\r\n        type: iteration-start\r\n      draggable: false\r\n      height: 48\r\n      id: 1731381770656start\r\n      parentId: '1731381770656'\r\n      position:\r\n        x: 24\r\n        y: 68\r\n      positionAbsolute:\r\n        x: 946.4922968503834\r\n        y: 365.5\r\n      selectable: false\r\n      sourcePosition: right\r\n      targetPosition: left\r\n      type: custom-iteration-start\r\n      width: 44\r\n      zIndex: 1002\r\n    - data:\r\n        authorization:\r\n          config: null\r\n          type: no-auth\r\n        body:\r\n          data: []\r\n          type: none\r\n        desc: ''\r\n        headers: ''\r\n        isInIteration: true\r\n        iteration_id: '1731381770656'\r\n        method: post\r\n        params: ''\r\n        selected: false\r\n        timeout:\r\n          max_connect_timeout: 0\r\n          max_read_timeout: 0\r\n          max_write_timeout: 0\r\n        title: HTTP \u8bf7\u6c42\r\n        type: http-request\r\n        url: https://www.runoob.com/test/demo_form.php\r\n        variables: []\r\n      height: 110\r\n      id: '1731382677649'\r\n      parentId: '1731381770656'\r\n      position:\r\n        x: 128\r\n        y: 68\r\n      positionAbsolute:\r\n        x: 1050.4922968503834\r\n        y: 365.5\r\n      sourcePosition: right\r\n      targetPosition: left\r\n      type: custom\r\n      width: 244\r\n      zIndex: 1002\r\n    - data:\r\n        desc: ''\r\n        outputs:\r\n        - value_selector:\r\n          - '1731381770656'\r\n          - output\r\n          variable: test\r\n        selected: false\r\n        title: \u7ed3\u675f\r\n        type: end\r\n      height: 90\r\n      id: '1731381793827'\r\n      position:\r\n        x: 1388.3743580708651\r\n        y: 297.5\r\n      positionAbsolute:\r\n        x: 1388.3743580708651\r\n        y: 297.5\r\n      selected: false\r\n      sourcePosition: right\r\n      targetPosition: left\r\n      type: custom\r\n      width: 244\r\n    - data:\r\n        code: \"\\ndef main(arg1: str) -> dict:\\n    return {\\n        \\\"trans_topic_str\\\"\\\r\n          : \\\"OpenAI\u9ad8\u7ba1\u79bb\u804c\u539f\u56e0\u5206\u6790\\\\nReasons Behind OpenAI Executive Departures\\\\nOpenAI\u9ad8\u7ba1\u79bb\u804c\u5bf9\u516c\u53f8\u672a\u6765\u53d1\u5c55\u7684\u5f71\u54cd\\\\\\\r\n          nImpact of OpenAI Executive Departure on Future Development\\\\nOpenAI\u9ad8\u7ba1\u79bb\u804c\u5bf9\u5458\u5de5\u58eb\u6c14\u7684\u5f71\u54cd\\\\\\\r\n          nEffect of OpenAI Executive Departure on Employee Morale\\\\nOpenAI\u9ad8\u7ba1\u79bb\u804c\u5bf9\u6295\u8d44\u8005\u4fe1\u5fc3\u7684\u5f71\u54cd\\\\\\\r\n          nImpact of OpenAI Executive Departure on Investor Confidence\\\\nOpenAI\u9ad8\u7ba1\u79bb\u804c\u5bf9\u7ade\u4e89\u5bf9\u624b\u7684\u5f71\u54cd\\\\\\\r\n          nEffect of OpenAI Executive Departure on Competitors\\\\nOpenAI\u9ad8\u7ba1\u79bb\u804c\u540e\u7684\u65b0\u52a8\u5411\\\\\\\r\n          nNew Directions for Departed OpenAI Executives\\\\nOpenAI\u9ad8\u7ba1\u79bb\u804c\u4e0e\u516c\u53f8\u6cbb\u7406\u7ed3\u6784\u7684\u5173\u7cfb\\\\\\\r\n          nRelationship Between OpenAI Executive Departure and Corporate Governance\\\\\\\r\n          nOpenAI\u9ad8\u7ba1\u79bb\u804c\u5bf9\u4e2d\u56fd\u5e02\u573a\u7684\u5f71\u54cd\\\\nImpact of OpenAI Executive Departure on the Chinese\\\r\n          \\ Market\\\\nOpenAI\u9ad8\u7ba1\u79bb\u804c\u5bf9\u56fd\u9645\u4e1a\u52a1\u5e03\u5c40\u7684\u5f71\u54cd\\\\nImpact of OpenAI Executive Departure on\\\r\n          \\ International Business Strategy\\\"\\n    }\\n\"\r\n        code_language: python3\r\n        desc: ''\r\n        outputs:\r\n          trans_topic_str:\r\n            children: null\r\n            type: string\r\n        selected: false\r\n        title: \u4ee3\u7801\u6267\u884c 2\r\n        type: code\r\n        variables:\r\n        - value_selector:\r\n          - '1730169413286'\r\n          - initial_topic\r\n          variable: arg1\r\n      height: 54\r\n      id: '1731381870748'\r\n      position:\r\n        x: 334\r\n        y: 297.5\r\n      positionAbsolute:\r\n        x: 334\r\n        y: 297.5\r\n      selected: false\r\n      sourcePosition: right\r\n      targetPosition: left\r\n      type: custom\r\n      width: 244\r\n    viewport:\r\n      x: -280.60174690457256\r\n      y: 82.19270013409931\r\n      zoom: 1.230283227908955\r\n```\r\n\r\n### \u2714\ufe0f Expected Behavior\r\n\r\nexpected got http result\r\n\r\n### \u274c Actual Behavior\r\n\r\nwrong:  Reached maximum retries (3) for URL https://www.runoob.com/test/demo_form.php",
                    "state": "CLOSED",
                    "comments": {
                        "nodes": [
                            {
                                "author": {
                                    "login": "dosubot"
                                },
                                "body": "<!-- Greeting -->\nHey @143230! \ud83d\udc4b I'm here to help you with bug reports, answer questions, and guide you on becoming a contributor. Let's squash those bugs together!\n\n<!-- Answer -->\nI found similar discussions regarding the \"Reached maximum retries\" error when using HTTP requests in Dify:\n\n1. [I'm encountering an error message 'Reached maximum retries (3) for URL ...' when using the HTTP request component in Dify.](https://github.com/langgenius/dify/discussions/10322) <sup>[[1]](https://github.com/langgenius/dify/discussions/10322)</sup>\n2. [[cloud.dify.ai] Node HTTP Request run failed: Reached maximum retries (3) for URL https://api.dify.ai/v1/chat-messages](https://github.com/langgenius/dify/discussions/6968) <sup>[[2]](https://github.com/langgenius/dify/discussions/6968)</sup>\n\nTo resolve this issue, you can increase the `max_retries` parameter when making the HTTP request. The default maximum retries are set by `SSRF_DEFAULT_MAX_RETRIES`, but you can override this by specifying a higher value in your request function call. For example, if you are using the `get` function, you can increase the retries like this:\n\n```python\nresponse = get(\"https://www.runoob.com/test/demo_form.php\", max_retries=5)\n```\n\nAdjust the `max_retries` value as needed to suit your requirements <sup>[[3]](https://github.com/langgenius/dify/blob/main/api/core/helper/ssrf_proxy.py)</sup>.\n\n\n<!-- Dosu Comment Footer -->\n*To continue talking to [Dosu](https://dosu.dev), mention @dosu.*\n"
                            },
                            {
                                "author": {
                                    "login": "143230"
                                },
                                "body": "hi, i think this is not a problem of max retries time reason, beacuse what retries i set, or change any other url, it can also repeat this problem, even for when using cloud.dify.ai, is also appears.\r\ni think it maybe a problem for httpx, or iteration nodes.\r\n![image](https://github.com/user-attachments/assets/3a738afd-d947-4575-a43c-113e2367b461)\r\n"
                            },
                            {
                                "author": {
                                    "login": "crazywoola"
                                },
                                "body": "https://github.com/langgenius/dify/blob/eb6c0b802737a2ed619f8a3bee8df73231398d98/docker/.env.example#L704-L707\r\n\r\nTry to leave those 2 blank.\r\n\r\nhttps://docs.dify.ai/learn-more/faq/install-faq#how-to-customize-the-proxy-behavior\r\n\r\nhttps://docs.dify.ai/learn-more/faq/install-faq#id-18.-why-is-ssrf_proxy-needed"
                            },
                            {
                                "author": {
                                    "login": "143230"
                                },
                                "body": "this works, thanks"
                            }
                        ]
                    }
                }
            }
        }
    }
]