[
    {
        "title": "fix: handle `shouldAddRateLimitToRoute` exception to prevent the server from crashing"
    },
    {
        "author": {
            "login": "PR Description"
        },
        "body": "> This issue was likely introduced when removing Restivus and refactoring the API routing: https://github.com/RocketChat/Rocket.Chat/pull/34999.\r\n\r\n## Proposed changes (including videos or screenshots)\r\n\r\nWhen running the `develop` branch with `yarn dsv` instead of `TEST_MODE=TRUE yarn dsv` we get the following error:\r\n\r\n```bash\r\n@rocket.chat/meteor:dsv: W20250205-07:14:37.576(1)? (STDERR) === UnCaughtException ===\r\n@rocket.chat/meteor:dsv: W20250205-07:14:37.576(1)? (STDERR) errorClass [Error]: [You must set \"intervalTimeInMS\" property in rateLimiter for REST API endpoint]\r\n\r\n[..snip]\r\n\r\n@rocket.chat/meteor:dsv: => Exited with code: 1\r\n@rocket.chat/meteor:dsv: => Your application is crashing. Waiting for file change.\r\n```\r\n\r\nThis error originates from `Rocket.Chat/apps/meteor/app/api/server/api.ts`, more specifically in the function responsible for refreshing API routes and applying rate-limiting:\r\n\r\n```javascript\r\n\tpublic reloadRoutesToRefreshRateLimiter(): void {\r\n\t\tthis._routes.forEach((route) => {\r\n\t\t\tif (this.shouldAddRateLimitToRoute(route.options)) {\r\n\t\t\t\tthis.addRateLimiterRuleForRoutes({\r\n\t\t\t\t\troutes: [route.path],\r\n\t\t\t\t\trateLimiterOptions: route.options.rateLimiterOptions || defaultRateLimiterOptions,\r\n\t\t\t\t\tendpoints: Object.keys(route.endpoints).filter((endpoint) => endpoint !== 'options'),\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n```\r\n\r\nThis function:\r\n\r\n1. Checks if rate-limiting should be applied using `shouldAddRateLimitToRoute(route.options)`.\r\n2. Applies the rate-limiter using `addRateLimiterRuleForRoutes` if the check returns `true`.\r\n\r\nThe function `addRateLimiterRuleForRoutes` enforces that both `numRequestsAllowed` and `intervalTimeInMS` must be defined - otherwise, it will throw an error:\r\n\r\n```javascript\r\nprotected addRateLimiterRuleForRoutes({\r\n\t\troutes,\r\n\t\trateLimiterOptions,\r\n\t\tendpoints,\r\n\t}: {\r\n\t\troutes: string[];\r\n\t\trateLimiterOptions: RateLimiterOptions | boolean;\r\n\t\tendpoints: string[];\r\n\t}): void {\r\n\t\tif (typeof rateLimiterOptions !== 'object') {\r\n\t\t\tthrow new Meteor.Error('\"rateLimiterOptions\" must be an object');\r\n\t\t}\r\n\t\tif (!rateLimiterOptions.numRequestsAllowed) {\r\n\t\t\tthrow new Meteor.Error('You must set \"numRequestsAllowed\" property in rateLimiter for REST API endpoint');\r\n\t\t}\r\n\t\tif (!rateLimiterOptions.intervalTimeInMS) {\r\n\t\t\tthrow new Meteor.Error('You must set \"intervalTimeInMS\" property in rateLimiter for REST API endpoint');\r\n\t\t}\r\n\r\n[...snip]\r\n```\r\n\r\nHowever, `shouldAddRateLimitToRoute` does not strictly enforce that `numRequestsAllowed` and `intervalTimeInMS` are defined - instead, it only checks whether `rateLimiterOptions` is an object:\r\n\r\n```javascript\r\n\tprotected shouldAddRateLimitToRoute(options: { rateLimiterOptions?: RateLimiterOptions | boolean }): boolean {\r\n\t\tconst { rateLimiterOptions } = options;\r\n\t\treturn (\r\n\t\t\t(typeof rateLimiterOptions === 'object' || rateLimiterOptions === undefined) &&\r\n\t\t\tBoolean(this.version) &&\r\n\t\t\t!process.env.TEST_MODE &&\r\n\t\t\tBoolean(defaultRateLimiterOptions.numRequestsAllowed && defaultRateLimiterOptions.intervalTimeInMS)\r\n\t\t);\r\n\t}\r\n```\r\n\r\nAs a result, the following configuration evaluates to `true` - even if `settings.get('API_Enable_Rate_Limiter_Limit_Time_Default')` is `undefined` (which can happen when the server starts for the first time), leading to the uncaught exception:\r\n\r\n```javascript\r\nAPI.v1.addRoute(\r\n\t'users.register',\r\n\t{\r\n\t\tauthRequired: false,\r\n\t\trateLimiterOptions: {\r\n\t\t\tnumRequestsAllowed: settings.get('Rate_Limiter_Limit_RegisterUser') ?? 1,\r\n\t\t\tintervalTimeInMS: settings.get('API_Enable_Rate_Limiter_Limit_Time_Default'),\r\n\t\t},\r\n\t\tvalidateParams: isUserRegisterParamsPOST,\r\n\t},\r\n```\r\n\r\nThis PR handles the exception to prevent the server from crashing and adds a fallback value to `intervalTimeInMS: settings.get('API_Enable_Rate_Limiter_Limit_Time_Default')` in the `users.register` route.\r\n\r\n## Issue(s)\r\n[SB-763](https://rocketchat.atlassian.net/jira/software/c/projects/SB/boards/63?search=fix&selectedIssue=SB-763)\r\n\r\n## Steps to test or reproduce\r\nFetch latest `develop` branch and start the server with `yarn dsv`. \r\n\r\n## Further comments\r\n- Tested on a Macbook Air M2.\r\n- It may only happen with new servers since older servers will likely have the necessary default values initiated.\r\n\r\n\r\n[SB-763]: https://rocketchat.atlassian.net/browse/SB-763?atlOrigin=eyJpIjoiNWRkNTljNzYxNjVmNDY3MDlhMDU5Y2ZhYzA5YTRkZjUiLCJwIjoiZ2l0aHViLWNvbS1KU1cifQ"
    },
    {
        "author": {
            "login": "ricardogarim"
        },
        "body": ""
    },
    {
        "author": {
            "login": "dionisio-bot"
        },
        "body": "Looks like this PR is ready to merge! \ud83c\udf89\nIf you have any trouble, please check the [PR guidelines](https://handbook.rocket.chat/departments-and-operations/research-and-development/engineering/development/pr-general-instructions-and-handling)"
    },
    {
        "author": {
            "login": "changeset-bot"
        },
        "body": "###  \u26a0\ufe0f  No Changeset found\n\nLatest commit: 7d6b0cf7916817dba7768d2b3f06453f6d3606bf\n\nMerging this PR will not cause a version bump for any packages. If these changes should not result in a new version, you're good to go. **If these changes should result in a version bump, you need to add a changeset.**\n\n<details><summary>This PR includes no changesets</summary>\n\n  When changesets are added to this PR, you'll see the packages that this PR includes changesets for and the associated semver types\n\n</details>\n\n[Click here to learn what changesets are, and how to add one](https://github.com/changesets/changesets/blob/main/docs/adding-a-changeset.md).\n\n[Click here if you're a maintainer who wants to add a changeset to this PR](https://github.com/RocketChat/Rocket.Chat/new/fix-rate-limiting-logic?filename=.changeset/rude-badgers-juggle.md&value=---%0A%22%40rocket.chat%2Fmeteor%22%3A%20patch%0A---%0A%0Afix%3A%20handle%20%60shouldAddRateLimitToRoute%60%20exception%20to%20prevent%20the%20server%20from%20crashing%0A)\n\n"
    },
    {
        "author": {
            "login": "codecov"
        },
        "body": "## [Codecov](https://app.codecov.io/gh/RocketChat/Rocket.Chat/pull/35117?dropdown=coverage&src=pr&el=h1&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=RocketChat) Report\nAll modified and coverable lines are covered by tests :white_check_mark:\n> Project coverage is 59.22%. Comparing base [(`4480b28`)](https://app.codecov.io/gh/RocketChat/Rocket.Chat/commit/4480b2883d9281d188a61b488abac5ad54a8524d?dropdown=coverage&el=desc&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=RocketChat) to head [(`7d6b0cf`)](https://app.codecov.io/gh/RocketChat/Rocket.Chat/commit/7d6b0cf7916817dba7768d2b3f06453f6d3606bf?dropdown=coverage&el=desc&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=RocketChat).\n> Report is 1 commits behind head on develop.\n\n<details><summary>Additional details and impacted files</summary>\n\n\n[![Impacted file tree graph](https://app.codecov.io/gh/RocketChat/Rocket.Chat/pull/35117/graphs/tree.svg?width=650&height=150&src=pr&token=lEAH159Fca&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=RocketChat)](https://app.codecov.io/gh/RocketChat/Rocket.Chat/pull/35117?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=RocketChat)\n\n```diff\n@@           Coverage Diff            @@\n##           develop   #35117   +/-   ##\n========================================\n  Coverage    59.22%   59.22%           \n========================================\n  Files         2824     2824           \n  Lines        67980    67980           \n  Branches     15117    15117           \n========================================\n  Hits         40259    40259           \n  Misses       24892    24892           \n  Partials      2829     2829           \n```\n\n| [Flag](https://app.codecov.io/gh/RocketChat/Rocket.Chat/pull/35117/flags?src=pr&el=flags&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=RocketChat) | Coverage \u0394 | |\n|---|---|---|\n| [unit](https://app.codecov.io/gh/RocketChat/Rocket.Chat/pull/35117/flags?src=pr&el=flag&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=RocketChat) | `75.17% <\u00f8> (\u00f8)` | |\n\nFlags with carried forward coverage won't be shown. [Click here](https://docs.codecov.io/docs/carryforward-flags?utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=RocketChat#carryforward-flags-in-the-pull-request-comment) to find out more.\n\n</details>"
    },
    {
        "author": {
            "login": "github-actions"
        },
        "body": "[PR Preview Action](https://github.com/rossjrw/pr-preview-action) v1.6.0\n:---:\n| <p></p> :rocket: View preview at <br> https://RocketChat.github.io/Rocket.Chat/pr-preview/pr-35117/ <br><br>\n| <h6>Built to branch [`gh-pages`](https://github.com/RocketChat/Rocket.Chat/tree/gh-pages) at 2025-02-05 06:46 UTC. <br> Preview will be ready when the [GitHub Pages deployment](https://github.com/RocketChat/Rocket.Chat/deployments) is complete. <br><br> </h6>\n<!-- Sticky Pull Request Commentpr-preview -->"
    },
    {
        "author": {
            "login": "imunique-ZJ"
        },
        "body": "Hi, I am curious about why the fallback value is set to `600000` while the default value in API_RATE_LIMIT setting is `60000`.\r\nhttps://github.com/RocketChat/Rocket.Chat/blob/1198e51de4a97d0fb3d4842394dc521f192362a7/apps/meteor/server/settings/rate.ts#L67-L70"
    }
]